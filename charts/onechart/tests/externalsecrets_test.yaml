suite: test externalsecrets
templates:
  - externalsecrets.yaml
tests:
  - it: Should not create ExternalSecret when externalSecret is not defined
    asserts:
      - hasDocuments:
          count: 0

  - it: Should create ExternalSecret with single dataFrom key
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: aws-cluster-secret-store
          kind: ClusterSecretStore
        files:
          my-secret:
            dataFrom:
              - /eks/uat/secrets
    asserts:
      - isKind:
          of: ExternalSecret
      - equal:
          path: metadata.name
          value: external-secret-release-name
      - equal:
          path: spec.refreshInterval
          value: "1h"
      - equal:
          path: spec.secretStoreRef.name
          value: aws-cluster-secret-store
      - equal:
          path: spec.secretStoreRef.kind
          value: ClusterSecretStore
      - equal:
          path: spec.target.name
          value: my-secret
      - equal:
          path: spec.dataFrom
          value:
            - extract:
                key: /eks/uat/secrets

  - it: Should create ExternalSecret with multiple dataFrom keys
    set:
      externalSecret:
        refreshInterval: "2h"
        secretStore:
          name: test-secret-store
          kind: SecretStore
        files:
          multi-secret:
            dataFrom:
              - /eks/uat/secret1
              - /eks/uat/secret2
              - /eks/shared/secret3
    asserts:
      - isKind:
          of: ExternalSecret
      - equal:
          path: spec.target.name
          value: multi-secret
      - equal:
          path: spec.dataFrom[0].extract.key
          value: /eks/uat/secret1
      - equal:
          path: spec.dataFrom[1].extract.key
          value: /eks/uat/secret2
      - equal:
          path: spec.dataFrom[2].extract.key
          value: /eks/shared/secret3

  - it: Should create multiple ExternalSecrets
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: default-store
          kind: ClusterSecretStore
        files:
          secret1:
            dataFrom:
              - /path/to/secret1
          secret2:
            dataFrom:
              - /path/to/secret2
    asserts:
      - hasDocuments:
          count: 2

  - it: Should set additionalLabels when defined
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: test-store
          kind: ClusterSecretStore
        additionalLabels:
          environment: production
          team: platform
        files:
          labeled-secret:
            dataFrom:
              - /eks/secrets
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            environment: production
            team: platform

  - it: Should set annotations when defined
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: test-store
          kind: ClusterSecretStore
        annotations:
          description: "Test ExternalSecret"
          owner: "platform-team"
        files:
          annotated-secret:
            dataFrom:
              - /eks/secrets
    asserts:
      - equal:
          path: metadata.annotations
          value:
            description: "Test ExternalSecret"
            owner: "platform-team"

  - it: Should use v1 API when available
    capabilities:
      apiVersions:
        - external-secrets.io/v1/ExternalSecret
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: test-store
          kind: ClusterSecretStore
        files:
          test-secret:
            dataFrom:
              - /eks/secrets
    asserts:
      - equal:
          path: apiVersion
          value: external-secrets.io/v1

  - it: Should use v1beta1 API when v1 not available
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: test-store
          kind: ClusterSecretStore
        files:
          test-secret:
            dataFrom:
              - /eks/secrets
    asserts:
      - equal:
          path: apiVersion
          value: external-secrets.io/v1beta1

  - it: Should override secretStore per file
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: default-store
          kind: ClusterSecretStore
        files:
          custom-store-secret:
            secretStore:
              name: custom-store
              kind: SecretStore
            dataFrom:
              - /eks/secrets
    asserts:
      - equal:
          path: spec.secretStoreRef.name
          value: custom-store
      - equal:
          path: spec.secretStoreRef.kind
          value: SecretStore

  - it: Should set custom target type
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: test-store
          kind: ClusterSecretStore
        files:
          typed-secret:
            type: kubernetes.io/dockerconfigjson
            dataFrom:
              - /eks/secrets
    asserts:
      - equal:
          path: spec.target.template.type
          value: kubernetes.io/dockerconfigjson

  - it: Should default to Opaque type
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: test-store
          kind: ClusterSecretStore
        files:
          default-type-secret:
            dataFrom:
              - /eks/secrets
    asserts:
      - equal:
          path: spec.target.template.type
          value: Opaque

  - it: Should include helm-chart labels
    set:
      externalSecret:
        refreshInterval: "1h"
        secretStore:
          name: test-store
          kind: ClusterSecretStore
        files:
          labeled-secret:
            dataFrom:
              - /eks/secrets
    asserts:
      - exists:
          path: metadata.labels
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: onechart
            app.kubernetes.io/instance: release-name
