suite: test serviceaccount
templates:
  - serviceaccount.yaml
tests:
  - it: Should create ServiceAccount when rbac.serviceAccount.enabled is true
    set:
      rbac:
        serviceAccount:
          enabled: true
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: release-name-sa
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: Should not create ServiceAccount when rbac.serviceAccount is not defined
    set:
      rbac:
        enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: Should not create ServiceAccount when rbac.serviceAccount.enabled is false
    set:
      rbac:
        serviceAccount:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: Should set annotations if defined
    set:
      rbac:
        serviceAccount:
          enabled: true
          annotations:
            example.com/annotation: "test-value"
            kubernetes.io/service-account: "custom"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            example.com/annotation: "test-value"
            kubernetes.io/service-account: "custom"

  - it: Should set additionalLabels if defined
    set:
      rbac:
        serviceAccount:
          enabled: true
          additionalLabels:
            custom-label: "custom-value"
            environment: "production"
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            custom-label: "custom-value"
            environment: "production"

  - it: Should not have labels when additionalLabels is not set
    set:
      rbac:
        serviceAccount:
          enabled: true
    asserts:
      - notExists:
          path: metadata.labels

  - it: Should work with both annotations and additionalLabels
    set:
      rbac:
        serviceAccount:
          enabled: true
          annotations:
            annotation-key: "annotation-value"
          additionalLabels:
            label-key: "label-value"
    asserts:
      - equal:
          path: metadata.annotations.annotation-key
          value: "annotation-value"
      - equal:
          path: metadata.labels.label-key
          value: "label-value"
